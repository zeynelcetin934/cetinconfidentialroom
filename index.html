<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bakkal Veresiye Paneli</title>
<style>
:root{--gold:#FFD700;--bg:#0b0b0b;--card:#1e1e1e;--panel:#1a1a1a;}
body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:#f5f5f5;}
.hidden{display:none;}
button,input{border:none;border-radius:6px;outline:none;font-size:16px;}
button{cursor:pointer;transition:all 0.2s;}
button:hover{transform:scale(1.05);}
a{text-decoration:none;color:inherit;}
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#111,#000);padding:20px;gap:10px;}
#loginScreen h1{font-size:42px;margin-bottom:10px;color:gold;text-shadow:0 0 12px var(--gold),0 0 20px #fff;text-align:center;}
.login-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
#loginScreen input{padding:14px;width:280px;background:#222;color:#fff;}
#loginScreen button{background:gold;color:#0d0d0d;padding:12px 18px;font-weight:bold;font-size:16px;border-radius:10px;box-shadow:0 0 12px rgba(255,215,0,0.6);}
#error{color:#ff5e5e;margin-top:10px;font-weight:bold;text-shadow:0 0 5px #ff5e5e;min-height:22px}
#mainScreen{padding:20px;animation:fadeIn 0.5s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
header{display:flex;justify-content:space-between;align-items:center;background:#1a1a1a;padding:16px;border-radius:12px;margin-bottom:20px;box-shadow:0 0 15px rgba(255,215,0,0.25);gap:10px;flex-wrap:wrap}
header h2{color:gold;text-shadow:0 0 12px var(--gold);font-size:24px;margin:0}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}
header button{background:#ffcc00;color:#0d0d0d;padding:10px 14px;font-weight:bold;border-radius:8px;box-shadow:0 0 10px rgba(255,215,0,0.4);}
section{margin-bottom:30px;}
.customer-list{display:flex;flex-direction:column;gap:12px;}
.customer-card{background:#222;padding:14px 16px;border-radius:12px;display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:6px 10px;align-items:center;transition:all 0.2s;box-shadow:0 0 8px rgba(0,0,0,0.5);position:relative;}
.customer-card:hover{background:#2b2b2b;transform:translateY(-1px);box-shadow:0 0 12px rgba(255,215,0,0.35);}
.c-name{font-weight:600;font-size:18px;}
.c-debt{justify-self:end;font-weight:800;font-size:18px;color:gold;}
.c-status{grid-column:1/2;grid-row:2/3;display:inline-flex;align-items:center;gap:6px;font-weight:600;padding:2px 8px;border-radius:999px;color:#fff;width:max-content}
.c-actions{grid-column:2/3;grid-row:2/3;justify-self:end;display:flex;gap:6px}
.btn-mini{padding:6px 10px;border-radius:8px;font-size:13px}
.btn-delete{background:#e74c3c;color:#fff}
.btn-open{background:#444;color:#fff}
#customerDetail{background:#1e1e1e;padding:20px;border-radius:14px;max-width:620px;margin:14px auto;animation:fadeSlide 0.3s;box-shadow:0 0 20px rgba(255,215,0,0.35);}
@keyframes fadeSlide{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
#customerDetail h2{color:gold;margin-bottom:6px;text-shadow:0 0 8px var(--gold);}
#customerDetail p{font-size:17px;margin:6px 0;}
#customerDetail ul{list-style:none;padding-left:0;max-height:250px;overflow-y:auto;margin-top:10px;border-top:1px solid #333;}
#customerDetail li{padding:10px 0;border-bottom:1px solid #333;display:flex;justify-content:space-between;}
.payment-section{display:flex;gap:10px;margin-top:12px;}
.payment-section input{flex:1;padding:10px;border-radius:8px;background:#333;color:#fff;}
.payment-section button{background:gold;color:#0d0d0d;font-weight:bold;box-shadow:0 0 8px rgba(255,215,0,0.4);}
#stats{background:#222;padding:16px;border-radius:12px;max-width:900px;margin:auto;box-shadow:0 0 12px rgba(255,215,0,0.25);margin-top:20px;}
canvas{background:#111;border-radius:10px;padding:10px;width:100%;height:auto;max-height:280px;}
#popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;visibility:hidden;opacity:0;transition:opacity 0.25s;}
#popup.show{visibility:visible;opacity:1;}
#popup-content{background:#1a1a1a;padding:20px;border-radius:16px;width:320px;display:flex;flex-direction:column;box-shadow:0 0 20px rgba(255,215,0,0.45);}
#popup-content input{padding:12px;margin-bottom:10px;background:#333;color:#fff;border-radius:8px;font-size:16px;}
#popup-content button{background:gold;color:#0d0d0d;padding:10px;font-weight:bold;border-radius:8px;box-shadow:0 0 10px rgba(255,215,0,0.45);}
#cameraModal{position:fixed;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:.25s}
#cameraModal.show{visibility:visible;opacity:1;}
.cam-box{background:#111;border:1px solid #333;border-radius:14px;padding:16px;max-width:480px;width:90%;display:flex;flex-direction:column;gap:10px;align-items:center}
video,canvas#overlay{width:100%;border-radius:10px;background:#000}
.back-btn{margin-bottom:12px;padding:8px 14px;background:#333;color:#fff;border-radius:6px;}
::-webkit-scrollbar{width:12px;}
::-webkit-scrollbar-track{background:#0b0b0b;}
::-webkit-scrollbar-thumb{background:gold;border-radius:6px;}
button:active{transform:scale(0.97);}
</style>
</head>
<body>
<div id="loginScreen">
<h1>Bakkal Veresiye Paneli</h1>
<div class="login-row">
<input type="password" id="passwordInput" placeholder="≈ûifre">
<button id="btnPwdLogin">Giri≈ü</button>
</div>
<div class="login-row">
<button id="btnFaceLogin">Y√ºzle Giri≈ü</button>
<button id="btnEnroll" title="En fazla 2 ki≈üi">Y√ºz Kaydet (maks. 2)</button>
</div>
<p id="error"></p>
</div>

<div id="mainScreen" class="hidden">
<header>
<h2 id="welcomeMsg">Merhaba</h2>
<div class="header-actions">
<button onclick="showAddCustomer()">+ Yeni M√º≈üteri</button>
<button onclick="downloadBackup()">Yedek ƒ∞ndir</button>
<button onclick="uploadBackup()">Yedekten Y√ºkle</button>
<button onclick="logout()">√áƒ±kƒ±≈ü</button>
</div>
</header>

<section>
<h3>M√º≈üteriler</h3>
<div id="customerList" class="customer-list"></div>
</section>

<section id="stats">
<h3>ƒ∞statistikler</h3>
<canvas id="debtChart" width="400" height="200"></canvas>
<canvas id="paymentChart" width="400" height="200" style="margin-top:20px;"></canvas>
</section>
</div>

<div id="customerDetail" class="hidden">
<button class="back-btn" onclick="closeDetail()">‚Üê Geri</button>
<h2 id="detailName"></h2>
<p>Toplam Bor√ß: <span id="detailTotal">0</span> TL</p>
<p>√ñdeme Durumu: <span id="detailStatus"></span></p>
<h3>√ñdeme Ge√ßmi≈üi</h3>
<ul id="paymentHistory"></ul>
<div class="payment-section">
<input type="number" id="paymentAmount" placeholder="√ñdenen Tutar">
<button onclick="addPayment()">√ñdendi</button>
</div>
</div>

<div id="popup">
<div id="popup-content">
<h3>Yeni M√º≈üteri Ekle</h3>
<input type="text" id="newCustomerName" placeholder="M√º≈üteri Adƒ±">
<input type="number" id="newCustomerDebt" placeholder="Ba≈ülangƒ±√ß Borcu">
<button onclick="addCustomer()">Ekle</button>
<button onclick="closePopup()" style="margin-top:10px;background:#333;color:#fff;">ƒ∞ptal</button>
</div>
</div>

<div id="cameraModal">
<div class="cam-box">
<h3 id="camTitle">Kamera</h3>
<video id="video" autoplay muted playsinline></video>
<canvas id="overlay"></canvas>
<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
<button id="btnCapture" class="btn-mini">Y√ºz√º Tara / Kaydet</button>
<button id="btnCloseCam" class="btn-mini" style="background:#444;color:#fff">Kapat</button>
</div>
<p id="camInfo" style="font-size:14px;opacity:.9;margin:0"></p>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
// --- Ayarlar ---
const PASSWORD="zeynelcetin934";
const MODEL_URL="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights";
const FACE_LIMIT=2;
const FACE_THRESHOLD=0.55;

// --- Veriler ---
let customers=JSON.parse(localStorage.getItem("customers"))||[];
let faceProfiles=(JSON.parse(localStorage.getItem("faceProfiles")||"[]")).map(p=>({label:p.label,descriptors:p.descriptors.map(d=>Float32Array.from(d))}));
let currentCustomer=null;
let debtChart,payChart;
let faceMatcher=null;
let currentMode="login";

// --- Kaydet / y√ºkle ---
function saveData(){localStorage.setItem("customers",JSON.stringify(customers));}
function saveFaces(){localStorage.setItem("faceProfiles",JSON.stringify(faceProfiles)); updateFaceMatcher(); updateEnrollButton();}
function updateFaceMatcher(){
    if(faceProfiles.length>0) faceMatcher=new faceapi.FaceMatcher(faceProfiles.map(p=>new faceapi.LabeledFaceDescriptors(p.label,p.descriptors)),FACE_THRESHOLD);
}
function updateEnrollButton(){document.getElementById("btnEnroll").classList.toggle("hidden",faceProfiles.length>=FACE_LIMIT);}
function money(n){return (Math.round((n+Number.EPSILON)*100)/100).toString().replace(".",",");}

// --- Login ---
document.getElementById("btnPwdLogin").onclick=()=>{const val=document.getElementById("passwordInput").value;if(val===PASSWORD) enterApp("≈ûifre");else showErr("≈ûifre yanlƒ±≈ü!");};
document.getElementById("btnFaceLogin").onclick=()=>openCamera("login");
document.getElementById("btnEnroll").onclick=()=>{if(faceProfiles.length>=FACE_LIMIT){showErr("En fazla 2 ki≈üi kaydedilebilir."); return;} openCamera("enroll");};
function showErr(msg){document.getElementById("error").innerText=msg; setTimeout(()=>{document.getElementById("error").innerText="";},3000);}
function enterApp(method){document.getElementById("loginScreen").classList.add("hidden"); document.getElementById("mainScreen").classList.remove("hidden"); document.getElementById("welcomeMsg").innerText=`Merhaba ${method==="≈ûifre"?"Kullanƒ±cƒ±":"üëã"}`; renderCustomers(); renderStats();}

// --- M√º≈üteri i≈ülemleri ---
function renderCustomers(){
    const list=document.getElementById("customerList"); list.innerHTML="";
    customers.forEach((c,i)=>{
        const card=document.createElement("div"); card.className="customer-card";
        let statusColor="#2ecc71", statusText="√ñdendi";
        if(c.debt>500){statusColor="#e74c3c"; statusText="Y√ºksek Bor√ß";}
        else if(c.debt>0){statusColor="#f39c12"; statusText="Bor√ß Var";}
        const nameEl=document.createElement("div"); nameEl.className="c-name"; nameEl.textContent=c.name;
        const debtEl=document.createElement("div"); debtEl.className="c-debt"; debtEl.textContent=`${c.debt} TL`;
        const statusEl=document.createElement("div"); statusEl.className="c-status"; statusEl.style.background=statusColor; statusEl.textContent=statusText;
        const actions=document.createElement("div"); actions.className="c-actions";
        const btnOpen=document.createElement("button"); btnOpen.className="btn-mini btn-open"; btnOpen.textContent="A√ß";
        const btnDel=document.createElement("button"); btnDel.className="btn-mini btn-delete"; btnDel.textContent="Sil";
        btnOpen.onclick=e=>{e.stopPropagation(); showDetail(i);};
        btnDel.onclick=e=>{e.stopPropagation(); deleteCustomer(i);};
        actions.appendChild(btnOpen); actions.appendChild(btnDel);
        card.appendChild(nameEl); card.appendChild(debtEl); card.appendChild(statusEl); card.appendChild(actions);
        card.onclick=()=>showDetail(i); list.appendChild(card);
    });
}

function showDetail(index){
    currentCustomer=customers[index];
    document.getElementById("mainScreen").classList.add("hidden");
    document.getElementById("customerDetail").classList.remove("hidden");
    document.getElementById("detailName").innerText=currentCustomer.name;
    document.getElementById("detailTotal").innerText=currentCustomer.debt;
    renderPayments(); updateDetailStatus();
}
function closeDetail(){currentCustomer=null; document.getElementById("customerDetail").classList.add("hidden"); document.getElementById("mainScreen").classList.remove("hidden"); renderCustomers(); renderStats();}
function renderPayments(){const ul=document.getElementById("paymentHistory"); ul.innerHTML=""; currentCustomer.payments.forEach(p=>{ const li=document.createElement("li"); li.innerHTML=`<span>${p.date}</span><span>${p.amount} TL</span>`; ul.appendChild(li); });}
function addPayment(){const val=parseFloat(document.getElementById("paymentAmount").value); if(!isNaN(val)&&val>0&&val<=currentCustomer.debt){ const today=new Date().toISOString().split('T')[0]; currentCustomer.payments.push({amount:val,date:today}); currentCustomer.debt=Math.max(0, +(currentCustomer.debt-val).toFixed(2)); saveData(); document.getElementById("paymentAmount").value=""; document.getElementById("detailTotal").innerText=currentCustomer.debt; renderPayments(); updateDetailStatus(); renderCustomers(); renderStats(); alert("√ñdeme kaydedildi ‚úÖ");} else alert("Ge√ßersiz tutar!");}
function updateDetailStatus(){const s=document.getElementById("detailStatus"); if(currentCustomer.debt===0){s.innerText="Bor√ß Yok"; s.style.color="#2ecc71";} else if(currentCustomer.debt<=200){s.innerText="D√º≈ü√ºk Bor√ß"; s.style.color="#f39c12";} else {s.innerText="Y√ºksek Bor√ß"; s.style.color="#e74c3c";}}

function showAddCustomer(){document.getElementById("popup").classList.add("show"); document.getElementById("newCustomerName").value=""; document.getElementById("newCustomerDebt").value="";}
function closePopup(){document.getElementById("popup").classList.remove("show");}
function addCustomer(){const name=document.getElementById("newCustomerName").value.trim(); const debt=parseFloat(document.getElementById("newCustomerDebt").value); if(!name){alert("M√º≈üteri adƒ± bo≈ü olamaz!"); return;} if(customers.some(c=>c.name.toLowerCase()===name.toLowerCase())){alert("Bu m√º≈üteri zaten var!"); return;} if(isNaN(debt)||debt<0){alert("Ge√ßerli bor√ß girin!"); return;} customers.push({name,debt,payments:[]}); saveData(); closePopup(); renderCustomers(); renderStats(); alert("M√º≈üteri eklendi ‚úÖ");}

function deleteCustomer(index){if(confirm(`${customers[index].name} silinsin mi?`)){customers.splice(index,1); saveData(); renderCustomers(); renderStats();}}

// --- Stats ---
function renderStats(){
    const labels=customers.map(c=>c.name);
    const debts=customers.map(c=>c.debt);
    const payments=customers.map(c=>c.payments.reduce((a,p)=>a+p.amount,0));

    if(debtChart){debtChart.destroy();}
    if(payChart){payChart.destroy();}

    const ctx1=document.getElementById("debtChart").getContext("2d");
    debtChart=new Chart(ctx1,{type:'bar',data:{labels, datasets:[{label:'Bor√ß (TL)', data:debts, backgroundColor:'gold'}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});

    const ctx2=document.getElementById("paymentChart").getContext("2d");
    payChart=new Chart(ctx2,{type:'bar',data:{labels, datasets:[{label:'√ñdeme (TL)', data:payments, backgroundColor:'#2ecc71'}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
}

// --- Backup / Restore ---
function downloadBackup(){
    const blob=new Blob([JSON.stringify({customers,faceProfiles})],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="backup.json"; a.click();
    URL.revokeObjectURL(url);
}
function uploadBackup(){
    const input=document.createElement("input"); input.type="file"; input.accept="application/json";
    input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=ev=>{
            try{
                const data=JSON.parse(ev.target.result);
                if(data.customers && data.faceProfiles){
                    customers=data.customers;
                    faceProfiles=data.faceProfiles.map(p=>({label:p.label,descriptors:p.descriptors.map(d=>Float32Array.from(d))}));
                    saveData(); saveFaces();
                    renderCustomers(); renderStats();
                    alert("Yedek y√ºklendi ‚úÖ");
                }else alert("Ge√ßersiz yedek!");
            }catch(err){alert("Hata: "+err);}
        };
        reader.readAsText(file);
    };
    input.click();
}

// --- Logout ---
function logout(){if(confirm("√áƒ±kmak istiyor musunuz?")){document.getElementById("mainScreen").classList.add("hidden"); document.getElementById("loginScreen").classList.remove("hidden");}}

// --- Kamera ve Y√ºz ---
async function openCamera(mode){
    currentMode=mode;
    document.getElementById("cameraModal").classList.add("show");
    const video=document.getElementById("video");
    const overlay=document.getElementById("overlay");
    const camInfo=document.getElementById("camInfo");
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
    await loadFaceAPI();
    const displaySize={width:video.videoWidth||480,height:video.videoHeight||360};
    faceapi.matchDimensions(overlay,displaySize);

    let detected=false;
    const interval=setInterval(async ()=>{
        if(video.paused || video.ended) return;
        const detections=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        overlay.getContext("2d").clearRect(0,0,overlay.width,overlay.height);
        if(detections){
            const resized=faceapi.resizeResults(detections,displaySize);
            faceapi.draw.drawDetections(overlay,resized);
            camInfo.innerText="Y√ºz algƒ±landƒ± ‚úî";
            detected=true;
        }else camInfo.innerText="Y√ºz algƒ±lanamadƒ± ...";
    },300);

    document.getElementById("btnCapture").onclick=async()=>{
        if(!detected){alert("Y√ºz algƒ±lanamadƒ±!"); return;}
        const detections=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if(!detections){alert("Y√ºz algƒ±lanamadƒ±!"); return;}
        if(currentMode==="enroll"){
            const label=prompt("Bu y√ºz√º kime kaydetmek istiyorsunuz?"); if(!label) return;
            faceProfiles.push({label, descriptors:[detections.descriptor]});
            saveFaces();
            alert("Y√ºz kaydedildi ‚úÖ"); closeCamera();
        }else if(currentMode==="login"){
            const match=faceMatcher.findBestMatch(detections.descriptor);
            if(match.label!=="unknown"){enterApp("Y√ºz"); closeCamera();} else alert("Y√ºz tanƒ±namadƒ±!"); 
        }
    };

    document.getElementById("btnCloseCam").onclick=()=>{closeCamera();}
    function closeCamera(){clearInterval(interval); video.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById("cameraModal").classList.remove("show");}
}

async function loadFaceAPI(){
    if(!window.faceapiLoaded){
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        window.faceapiLoaded=true;
        updateFaceMatcher();
    }
}

// --- Ba≈ülangƒ±√ß ---
updateFaceMatcher();
updateEnrollButton();
</script>
</body>
</html>
