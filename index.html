<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bakkal Veresiye Paneli - Gelişmiş</title>
<style>
  :root{--gold:#FFD700;--bg:#0b0b0b;--card:#1e1e1e;--panel:#1a1a1a;}
  body{margin:0;font-family:'Segoe UI',sans-serif;background:var(--bg);color:#f5f5f5;}
  .hidden{display:none;}
  button,input{border:none;border-radius:6px;outline:none;font-size:16px;}
  button{cursor:pointer;transition:all 0.2s;}
  button:hover{transform:scale(1.05);}
  a{text-decoration:none;color:inherit;}
  /* Login */
  #loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#111,#000);padding:20px;gap:10px;}
  #loginScreen h1{font-size:42px;margin-bottom:10px;color:gold;text-shadow:0 0 12px var(--gold),0 0 20px #fff;text-align:center;}
  .login-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  #loginScreen input{padding:14px;width:280px;background:#222;color:#fff;}
  #loginScreen button{background:gold;color:#0d0d0d;padding:12px 18px;font-weight:bold;font-size:16px;border-radius:10px;box-shadow:0 0 12px rgba(255,215,0,0.6);}
  #error{color:#ff5e5e;margin-top:10px;font-weight:bold;text-shadow:0 0 5px #ff5e5e;min-height:22px}
  /* Main */
  #mainScreen{padding:20px;animation:fadeIn 0.5s;}
  @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
  header{display:flex;justify-content:space-between;align-items:center;background:#1a1a1a;padding:16px;border-radius:12px;margin-bottom:20px;box-shadow:0 0 15px rgba(255,215,0,0.25);gap:10px;flex-wrap:wrap}
  header h2{color:gold;text-shadow:0 0 12px var(--gold);font-size:24px;margin:0}
  .header-actions{display:flex;gap:8px;flex-wrap:wrap}
  header button{background:#ffcc00;color:#0d0d0d;padding:10px 14px;font-weight:bold;border-radius:8px;box-shadow:0 0 10px rgba(255,215,0,0.4);}
  section{margin-bottom:30px;}
  /* Customer list */
  .customer-list{display:flex;flex-direction:column;gap:12px;}
  .customer-card{background:#222;padding:14px 16px;border-radius:12px;display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:6px 10px;align-items:center;transition:all 0.2s;box-shadow:0 0 8px rgba(0,0,0,0.5);position:relative;}
  .customer-card:hover{background:#2b2b2b;transform:translateY(-1px);box-shadow:0 0 12px rgba(255,215,0,0.35);}
  .c-name{font-weight:600;font-size:18px;}
  .c-debt{justify-self:end;font-weight:800;font-size:18px;color:gold;}
  .c-status{grid-column:1/2;grid-row:2/3;display:inline-flex;align-items:center;gap:6px;font-weight:600;padding:2px 8px;border-radius:999px;color:#fff;width:max-content}
  .c-actions{grid-column:2/3;grid-row:2/3;justify-self:end;display:flex;gap:6px}
  .btn-mini{padding:6px 10px;border-radius:8px;font-size:13px}
  .btn-delete{background:#e74c3c;color:#fff}
  .btn-open{background:#444;color:#fff}
  /* Detail */
  #customerDetail{background:#1e1e1e;padding:20px;border-radius:14px;max-width:620px;margin:14px auto;animation:fadeSlide 0.3s;box-shadow:0 0 20px rgba(255,215,0,0.35);}
  @keyframes fadeSlide{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
  #customerDetail h2{color:gold;margin-bottom:6px;text-shadow:0 0 8px var(--gold);}
  #customerDetail p{font-size:17px;margin:6px 0;}
  #customerDetail ul{list-style:none;padding-left:0;max-height:250px;overflow-y:auto;margin-top:10px;border-top:1px solid #333;}
  #customerDetail li{padding:10px 0;border-bottom:1px solid #333;display:flex;justify-content:space-between;}
  .payment-section{display:flex;gap:10px;margin-top:12px;}
  .payment-section input{flex:1;padding:10px;border-radius:8px;background:#333;color:#fff;}
  .payment-section button{background:gold;color:#0d0d0d;font-weight:bold;box-shadow:0 0 8px rgba(255,215,0,0.4);}
  /* Stats */
  #stats{background:#222;padding:16px;border-radius:12px;max-width:900px;margin:auto;box-shadow:0 0 12px rgba(255,215,0,0.25);margin-top:20px;}
  canvas{background:#111;border-radius:10px;padding:10px;width:100%;height:auto;max-height:280px;}
  /* Popup */
  #popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;visibility:hidden;opacity:0;transition:opacity 0.25s;}
  #popup.show{visibility:visible;opacity:1;}
  #popup-content{background:#1a1a1a;padding:20px;border-radius:16px;width:320px;display:flex;flex-direction:column;box-shadow:0 0 20px rgba(255,215,0,0.45);}
  #popup-content input{padding:12px;margin-bottom:10px;background:#333;color:#fff;border-radius:8px;font-size:16px;}
  #popup-content button{background:gold;color:#0d0d0d;padding:10px;font-weight:bold;border-radius:8px;box-shadow:0 0 10px rgba(255,215,0,0.45);}
  /* camera modal */
  #cameraModal{position:fixed;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:.25s}
  #cameraModal.show{visibility:visible;opacity:1;}
  .cam-box{background:#111;border:1px solid #333;border-radius:14px;padding:16px;max-width:480px;width:90%;display:flex;flex-direction:column;gap:10px;align-items:center}
  video,canvas#overlay{width:100%;border-radius:10px;background:#000}
  .back-btn{margin-bottom:12px;padding:8px 14px;background:#333;color:#fff;border-radius:6px;}
  /* scrollbars */
  ::-webkit-scrollbar{width:12px;}
  ::-webkit-scrollbar-track{background:#0b0b0b;}
  ::-webkit-scrollbar-thumb{background:gold;border-radius:6px;}
  button:active{transform:scale(0.97);}
  /* mesaj */
  #msgBox{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 18px;border-radius:8px;opacity:0;transition:.3s;z-index:999;}
  #msgBox.show{opacity:1;}
</style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen">
    <h1>Bakkal Veresiye Paneli</h1>
    <div class="login-row">
      <input type="password" id="passwordInput" placeholder="Şifre">
      <button id="btnPwdLogin">Giriş</button>
    </div>
    <div class="login-row">
      <button id="btnFaceLogin">Yüzle Giriş</button>
      <button id="btnEnroll" title="En fazla 2 kişi">Yüz Kaydet (maks. 2)</button>
    </div>
    <p id="error"></p>
  </div>

  <!-- MAIN -->
  <div id="mainScreen" class="hidden">
    <header>
      <h2 id="welcomeMsg">Merhaba</h2>
      <div class="header-actions">
        <button onclick="showAddCustomer()">+ Yeni Müşteri</button>
        <button onclick="downloadBackup()">Yedek İndir</button>
        <button onclick="uploadBackup()">Yedekten Yükle</button>
        <button onclick="logout()">Çıkış</button>
      </div>
    </header>

    <section>
      <h3>Müşteriler</h3>
      <div id="customerList" class="customer-list"></div>
    </section>

    <section id="stats">
      <h3>İstatistikler</h3>
      <canvas id="debtChart"></canvas>
      <canvas id="paymentChart" style="margin-top:20px;"></canvas>
    </section>
  </div>

  <!-- DETAIL -->
  <div id="customerDetail" class="hidden">
    <button class="back-btn" onclick="closeDetail()">← Geri</button>
    <h2 id="detailName"></h2>
    <p>Toplam Borç: <span id="detailTotal">0</span> TL</p>
    <p>Ödeme Durumu: <span id="detailStatus"></span></p>
    <h3>Ödeme Geçmişi</h3>
    <ul id="paymentHistory"></ul>
    <div class="payment-section">
      <input type="number" id="paymentAmount" placeholder="Ödenen Tutar">
      <button onclick="addPayment()">Ödendi</button>
    </div>
  </div>

  <!-- ADD CUSTOMER POPUP -->
  <div id="popup">
    <div id="popup-content">
      <h3>Yeni Müşteri Ekle</h3>
      <input type="text" id="newCustomerName" placeholder="Müşteri Adı">
      <input type="number" id="newCustomerDebt" placeholder="Başlangıç Borcu">
      <button onclick="addCustomer()">Ekle</button>
      <button onclick="closePopup()" style="margin-top:10px;background:#333;color:#fff;">İptal</button>
    </div>
  </div>

  <!-- CAMERA MODAL -->
  <div id="cameraModal">
    <div class="cam-box">
      <h3 id="camTitle">Kamera</h3>
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button id="btnCapture" class="btn-mini">Yüzü Tara / Kaydet</button>
        <button id="btnCloseCam" class="btn-mini" style="background:#444;color:#fff">Kapat</button>
      </div>
      <p id="camInfo" style="font-size:14px;opacity:.9;margin:0"></p>
    </div>
  </div>

  <div id="msgBox"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
/* =================== AYARLAR =================== */
const PASSWORD="zeynelcetin934";
const MODEL_URL="https://cdn.jsdelivr.net/npm/face-api.js/models";
const FACE_LIMIT=2;
const FACE_THRESHOLD=0.55;

/* =================== VERİLER =================== */
let customers=JSON.parse(localStorage.getItem("customers"))||[
  {name:"Ahmet",debt:300,payments:[{amount:50,date:"2025-08-10"}]},
  {name:"Ayşe",debt:150,payments:[]},
  {name:"Mehmet",debt:500,payments:[{amount:200,date:"2025-08-05"}]}
];
let faceProfiles=JSON.parse(localStorage.getItem("faceProfiles")||"[]");
let currentCustomer=null;
let debtChart,payChart;

/* =================== YARDIMCILAR =================== */
function saveData(){localStorage.setItem("customers",JSON.stringify(customers));}
function saveFaces(){localStorage.setItem("faceProfiles",JSON.stringify(faceProfiles));updateEnrollButton();}
function updateEnrollButton(){const btn=document.getElementById("btnEnroll");faceProfiles.length>=FACE_LIMIT?btn.classList.add("hidden"):btn.classList.remove("hidden");}
function money(n){return (Math.round((n+Number.EPSILON)*100)/100).toString().replace(".",",");}
function showMsg(txt){const box=document.getElementById("msgBox");box.innerText=txt;box.classList.add("show");setTimeout(()=>box.classList.remove("show"),2000);}

/* =================== GİRİŞ =================== */
document.getElementById("btnPwdLogin").onclick=()=>{
  const val=document.getElementById("passwordInput").value;
  if(val===PASSWORD){enterApp("Şifre");} else {showErr("Şifre yanlış!");}
};
document.getElementById("btnFaceLogin").onclick=()=>openCamera("login");
document.getElementById("btnEnroll").onclick=()=>{if(faceProfiles.length>=FACE_LIMIT){showErr("En fazla 2 kişi kaydedilebilir.");return;}openCamera("enroll");};
function showErr(msg){document.getElementById("error").innerText=msg;setTimeout(()=>{document.getElementById("error").innerText="";},3000);}
function enterApp(method){
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainScreen").classList.remove("hidden");
  document.getElementById("welcomeMsg").innerText =
    method==="Şifre" ? "Merhaba Kullanıcı" :
    method==="Face"   ? "Merhaba 😊" :
    "Merhaba";
  renderCustomers();renderStats();
}

/* =================== MÜŞTERİLER =================== */
function renderCustomers(){
  const list=document.getElementById("customerList");list.innerHTML="";
  customers.forEach((c,i)=>{
    const card=document.createElement("div");card.className="customer-card";
    let statusColor="#2ecc71",statusText="Ödendi";
    if(c.debt>500){statusColor="#e74c3c";statusText="Yüksek Borç";}
    else if(c.debt>0){statusColor="#f39c12";statusText="Borç Var";}
    const nameEl=document.createElement("div");nameEl.className="c-name";nameEl.textContent=c.name;
    const debtEl=document.createElement("div");debtEl.className="c-debt";debtEl.textContent=`${money(c.debt)} TL`;
    const statusEl=document.createElement("div");statusEl.className="c-status";statusEl.style.background=statusColor;statusEl.textContent=statusText;
    const actions=document.createElement("div");actions.className="c-actions";
    const btnOpen=document.createElement("button");btnOpen.className="btn-mini btn-open";btnOpen.textContent="Aç";
    const btnDel=document.createElement("button");btnDel.className="btn-mini btn-delete";btnDel.textContent="Sil";
    btnOpen.onclick=(e)=>{e.stopPropagation();showDetail(i);};btnDel.onclick=(e)=>{e.stopPropagation();deleteCustomer(i);};
    actions.appendChild(btnOpen);actions.appendChild(btnDel);
    card.appendChild(nameEl);card.appendChild(debtEl);card.appendChild(statusEl);card.appendChild(actions);
    card.onclick=()=>showDetail(i);list.appendChild(card);
  });
}
function showDetail(index){
  currentCustomer=customers[index];
  document.getElementById("mainScreen").classList.add("hidden");
  document.getElementById("customerDetail").classList.remove("hidden");
  document.getElementById("detailName").innerText=currentCustomer.name;
  document.getElementById("detailTotal").innerText=money(currentCustomer.debt);
  renderPayments();updateDetailStatus();
}
function closeDetail(){currentCustomer=null;document.getElementById("customerDetail").classList.add("hidden");
                       function closeDetail(){
  currentCustomer=null;
  document.getElementById("customerDetail").classList.add("hidden");
  document.getElementById("mainScreen").classList.remove("hidden");
}
function renderPayments(){
  const list=document.getElementById("paymentHistory");list.innerHTML="";
  currentCustomer.payments.forEach(p=>{
    const li=document.createElement("li");
    li.textContent=`${p.amount} TL - ${p.date}`;
    list.appendChild(li);
  });
}
function updateDetailStatus(){
  let st="Ödendi";
  if(currentCustomer.debt>500)st="Yüksek Borç";
  else if(currentCustomer.debt>0)st="Borç Var";
  document.getElementById("detailStatus").innerText=st;
}
function addPayment(){
  const amt=parseFloat(document.getElementById("paymentAmount").value);
  if(isNaN(amt)||amt<=0)return;
  currentCustomer.debt-=amt;
  currentCustomer.payments.push({amount:amt,date:new Date().toLocaleDateString()});
  saveData();document.getElementById("detailTotal").innerText=money(currentCustomer.debt);
  renderPayments();updateDetailStatus();renderCustomers();renderStats();
  document.getElementById("paymentAmount").value="";
}
function deleteCustomer(i){
  if(confirm("Silmek istediğine emin misin?")){
    customers.splice(i,1);saveData();renderCustomers();renderStats();
  }
}

/* =================== YENİ MÜŞTERİ =================== */
function showAddCustomer(){document.getElementById("popup").classList.add("show");}
function closePopup(){document.getElementById("popup").classList.remove("show");}
function addCustomer(){
  const n=document.getElementById("newCustomerName").value.trim();
  const d=parseFloat(document.getElementById("newCustomerDebt").value)||0;
  if(!n)return;
  customers.push({name:n,debt:d,payments:[]});
  saveData();closePopup();renderCustomers();renderStats();
  document.getElementById("newCustomerName").value="";
  document.getElementById("newCustomerDebt").value="";
}

/* =================== YEDEK =================== */
function downloadBackup(){
  const data={customers,faces:faceProfiles};
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="yedek.json";a.click();
}
function uploadBackup(){
  const inp=document.createElement("input");inp.type="file";inp.accept=".json";
  inp.onchange=()=>{
    const f=inp.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
      try{
        const obj=JSON.parse(e.target.result);
        if(obj.customers&&Array.isArray(obj.customers))customers=obj.customers;
        if(obj.faces&&Array.isArray(obj.faces))faceProfiles=obj.faces;
        saveData();saveFaces();renderCustomers();renderStats();showMsg("Yedek yüklendi!");
      }catch(err){showMsg("Hatalı dosya");}
    };r.readAsText(f);
  };inp.click();
}

/* =================== ÇIKIŞ =================== */
function logout(){
  document.getElementById("mainScreen").classList.add("hidden");
  document.getElementById("customerDetail").classList.add("hidden");
  document.getElementById("loginScreen").classList.remove("hidden");
}

/* =================== İSTATİSTİK =================== */
function renderStats(){
  const ctx=document.getElementById("debtChart").getContext("2d");
  const ctx2=document.getElementById("paymentChart").getContext("2d");
  if(debtChart)debtChart.destroy();if(payChart)payChart.destroy();
  debtChart=new Chart(ctx,{type:"bar",data:{
    labels:customers.map(c=>c.name),
    datasets:[{label:"Borçlar",data:customers.map(c=>c.debt),backgroundColor:"gold"}]
  }});
  let dates={},labels=[],data=[];
  customers.forEach(c=>c.payments.forEach(p=>{
    dates[p.date]=(dates[p.date]||0)+p.amount;
  }));
  labels=Object.keys(dates);data=Object.values(dates);
  payChart=new Chart(ctx2,{type:"line",data:{
    labels:labels,
    datasets:[{label:"Ödemeler",data:data,borderColor:"gold",tension:.3}]}
  });
}

/* =================== KAMERA & FACE =================== */
let video=document.getElementById("video");
let overlay=document.getElementById("overlay");
let ctx=overlay.getContext("2d");
let camMode=null;

async function openCamera(mode){
  camMode=mode;
  document.getElementById("cameraModal").classList.add("show");
  document.getElementById("camTitle").innerText=mode==="login"?"Yüzle Giriş":"Yüz Kaydet";
  document.getElementById("camInfo").innerText="Kamera açılıyor...";
  try{
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;video.setAttribute("playsinline",true);
    await video.play();
    requestAnimationFrame(runDetection);
  }catch(e){showMsg("Kamera açılamadı!");}
}
function closeCamera(){
  document.getElementById("cameraModal").classList.remove("show");
  if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());}
}
document.getElementById("btnCloseCam").onclick=closeCamera;

async function runDetection(){
  if(video.readyState!==4)return requestAnimationFrame(runDetection);
  overlay.width=video.videoWidth;overlay.height=video.videoHeight;
  const det=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  ctx.clearRect(0,0,overlay.width,overlay.height);
  if(det){faceapi.draw.drawDetections(overlay,[det]);}
  if(document.getElementById("cameraModal").classList.contains("show"))
    requestAnimationFrame(runDetection);
}

document.getElementById("btnCapture").onclick=async()=>{
  const det=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det){showMsg("Yüz bulunamadı");return;}
  if(camMode==="enroll"){
    if(faceProfiles.length>=FACE_LIMIT){showMsg("Limit dolu");return;}
    faceProfiles.push(Array.from(det.descriptor));
    saveFaces();showMsg("Yüz kaydedildi");closeCamera();
  }else if(camMode==="login"){
    if(faceProfiles.length===0){showMsg("Kayıtlı yüz yok");return;}
    let best={dist:1};for(let f of faceProfiles){
      let d=faceapi.euclideanDistance(det.descriptor,f);
      if(d<best.dist)best={dist:d};
    }
    if(best.dist<FACE_THRESHOLD){closeCamera();enterApp("Face");}
    else{showMsg("Yüz tanınmadı");}
  }
};

updateEnrollButton();
</script>
</body>
</html>
